{% extends "_base.html" %}
{% load static %}
{% block title %}Perfil do Aluno{% endblock %}

{% block content %}
<div class="w-full max-w-6xl mx-auto p-6 space-y-6"
     x-data="Object.assign({ tab: 'frequencia' }, mainPage(), actions())">

  <!-- Card informações do aluno -->
  <div class="bg-white rounded-2xl shadow p-6 relative">
    <div class="font-bold mb-4">Informações do aluno:</div>
    <div class="grid grid-cols-3 gap-6 text-sm">
      <div>
        <p class="flex flex-col mb-5"><strong>Nome:</strong> {{ obj.name }} </p>
        <p class="flex flex-col"><strong>Plano:</strong> {{ obj.plan }} </p>
      </div>
      <div >
        <p class="flex flex-col mb-5"><strong>CPF:</strong> {{ obj.cpf_cnpj }}</p>
        <p class="flex flex-col"><strong>Status:</strong>

          {% if obj.status|lower == 'ativo' %}
            <span class="text-green-600 font-semibold">{{ obj.status }}</span>
          {% else %}
            <span class="text-red-600 font-semibold">{{ obj.status }}</span>
          {% endif %}

          </p>
      </div>
      <div>
        <p class="flex flex-col mb-5"><strong>Telefone:</strong> {{ obj.phone_number }}</p>
        <p class="flex flex-col"><strong>Início:</strong> {{ obj.created_at|date:'d \\d\\e F \\d\\e Y'}}</p>
      </div>
    </div>
    <!-- Botões de ação -->
    <div  class="absolute top-4 right-4 flex gap-2">
      <button  x-data
        data-id="{{ obj.id }}"
        data-name="{{ obj.name }}"
        data-cpf_cnpj="{{ obj.cpf_cnpj }}"
        data-date_of_birth="{{ obj.date_of_birth|date:'Y-m-d' }}"
        data-phone_number="{{ obj.phone_number }}"
        data-url-update="{% url 'student_api' obj.id %}"
        @click="openUpdate($el.dataset)"
        class="bg-black text-white p-2 rounded-full hover:bg-gray-600">
       <i data-lucide="pencil"></i>
      </button>
      <button @click="openModalDelete = true" class="bg-black text-white p-2 rounded-full hover:bg-red-600">
        <i data-lucide="trash"></i>
      </button>
    </div>
    {% if obj.status.status|lower == 'inativo' %}
      <button x-data
        data-id="{{ obj.id }}"
        data-name="{{ obj.name|escape }}"
        data-cpf_cnpj="{{ obj.cpf_cnpj|default_if_none:'' }}"
        data-date_of_birth="{{ obj.date_of_birth|date:'Y-m-d' }}"
        data-phone_number="{{ obj.phone_number|default_if_none:'' }}"
        data-url-update="{% url 'student_api' obj.id %}"
        data-plan-id="{{ obj.plan.id }}"
        @click="openActive($el.dataset)"
        class="absolute bottom-4 right-5 bg-green-500 rounded-lg px-5 text-white text-sm">
        Ativar
      </button>
    {% endif %}
  </div>

  <!-- Abas -->
  <div class="bg-white p-4 rounded-3xl">
        <menu class="bg-[#E9E7E7] w-3/5 flex ml-6 rounded-t-2xl overflow-hidden">
          <button
            @click="tab = 'frequencia'"
            :class="{
            'bg-transparent border-none rounded-b-none relative z-10': tab === 'frequencia',
            'bg-[#C4C2C2] rounded-br-full rounded-bl-none': tab === 'mensalidades',
            'bg-[#C4C2C2] rounded-b-none': tab === 'historico',
            }"
            class="px-6 py-2 grow rounded-t-2xl  text-sm font-medium transition hover:cursor-pointer">
            Frequência
          </button>
          <button
            @click="tab = 'mensalidades'"
            :class="{
            'bg-transparent border-none rounded-b-none relative z-10': tab === 'mensalidades',
            'bg-[#C4C2C2] rounded-bl-full rounded-br-none': tab === 'frequencia',
            'bg-[#C4C2C2] rounded-bl-none rounded-br-full': tab === 'historico',
            }"
            class="px-6 py-2 grow mx-[-6px] rounded-t-2xl text-sm font-medium transition hover:cursor-pointer">
            Mensalidades
          </button>
          <button
            @click="tab = 'historico'"
            :class="{
            'bg-transparent border-none rounded-b-none relative z-10': tab === 'historico',
            'bg-[#C4C2C2] rounded-bl-full rounded-br-none': tab === 'mensalidades',
            'bg-[#C4C2C2] rounded-b-none': tab === 'frequencia',
            }"
            class="px-6 py-2 grow rounded-t-2xl text-sm font-medium transition hover:cursor-pointer">
            Histórico
          </button>
        </menu>

    <div class="bg-[#E9E7E7] relative z-5 rounded-2xl shadow-inner mt-[-4px]">
      <!-- Conteúdo das abas -->
      <div class="p-4" x-show="tab === 'frequencia'">
        <div class="p-4 flex gap-4 items-center">
          <i data-lucide="calendar" class="text-gray-600"></i>
          <span class="text-sm text-gray-600">Registros de presença mais recentes primeiro</span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm border-collapse">
            <thead>
              <tr class="border-gray-300 border-b text-gray-500">
                <th class="p-3 border-r border-gray-300">Data</th>
                <th class="p-3 border-r border-gray-300">Status</th>
                <th class="p-3">Registrado em</th>
              </tr>
            </thead>
            <tbody>
              {% if frequency %}
                {% for record in frequency %}
                  <tr class="border-b border-gray-100">
                    <td class="p-3">{{ record.attendance_date|date:"d/m/Y" }}</td>
                    <td class="p-3 text-green-600 font-semibold">Presente</td>
                    <td class="p-3 text-gray-500">{{ record.created_at|date:"d/m/Y H:i" }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                  <tr>
                    <td colspan="3" class="p-4 text-center text-gray-500">Nenhum registro de frequência encontrado.</td>
                  </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="p-4" x-show="tab === 'mensalidades'">
        <!-- Tabela -->
        <div class="overflow-x-auto p-4">
          <table class="w-full text-sm">
            <thead >
              <tr class="text-left border-gray-500 border-b text-gray-500">
                <th class="pl-2 border-gray-500 border-r">Mês</th>
                <th class="pl-2 border-gray-500 border-r">Status</th>
                <th class="pl-2 border-gray-500 border-r">Valor</th>
                <th class="pl-2 border-gray-500 border-r">Vencimento</th>
                <th class="pl-2 border-gray-500 border-r">Plano</th>
                <th class="pl-a">Data do pagamento</th>
              </tr>
            </thead>
            <tbody class="">
              {% for monthlyfee in monthlyfees %}
                <tr>
                  <td class="pt-2">{{monthlyfee.reference_month}}</td>
                  <td class="pt-2"><span class="">
                    {% if monthlyfee.paid %}
                      <span class="text-green-600">Pago</span>
                      {% else %}
                      <span class="text-red-600 font-semibold">Pendente</span>
                    {% endif %}
                      </span></td>
                  <td class="pt-2">R$ {{monthlyfee.amount}}</td>
                  <td class="pt-2">{{monthlyfee.due_date|date:"d/m/y"}}</td>
                  <td class="pt-2">{{monthlyfee.plan}}</td>
                  <td class="pt-2">{{monthlyfee.date_paid}}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="p-4" x-show="tab === 'historico'">
        {% for history in historys %}
          <p>{{history.created_at|date:"d/m/Y"}} - {{history.description}}</p>
        {% endfor %}

      </div>
    </div>
  </div>
  <!--MODAL DELETE-->
{% include 'components/_modal_delete.html' %}
<!--MODAL UPDATE-->
{% include 'components/_modal_update.html' %}
{% include 'components/_active_user.html'%}
{% include 'components/_notification_modal.html' %}
</div>


<script>
  lucide.createIcons();
</script>
<script src="{% static 'js/detail_students.js' %}"></script>
<script src="{% static 'js/form_user.js' %}"></script>
<script src="{% static 'js/home.js' %}"></script>
<script src="{% static 'js/notification_modal.js' %}"></script>
{% endblock %}
