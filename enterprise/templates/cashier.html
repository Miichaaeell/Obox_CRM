{% extends '_base.html' %}
{% load static %}

{% block title %}
    Caixa
{% endblock title %}


{% block content %}
  <div x-data="CashierHandler()">
    <!-- Header -->
    <div class="w-full max-w-6xl mb-6 flex gap-4 text-white" >
      <div class="flex gap-2">
        <span class="font-semibold">Situação:</span>
        <span class="font-bold" :class="{
        'text-green-500' : '{{status}}' === 'Aberto',
        'text-red-500' : '{{status}}' === 'Fechado'
        }"> {{status|title}}</span>
      </div>
       <div>

        {% if status == 'Aberto' %}
          <span class="font-semibold">Data de abertura:</span>
          <span class="font-bold">{{date_start}}</span>
          {% else %}
          <span class="font-semibold">Data de fechamento:</span>
          <span class="font-bold">{{date_end}}</span>
        {% endif %}


      </div>

    </div>
    <div class="w-full max-w-6xl grid grid-cols-4 gap-4">
      <!-- Coluna da esquerda: Cards -->
      <div class="col-span-1 flex flex-col gap-4">
        <!-- Entradas -->
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <h3 class="font-bold text-lg mb-3 bg-green-600 w-100 p-3" >(+) Entradas</h3>
          <div class="flex px-3 py-1 justify-between"><span>Pix</span><span>R$ {{ income_pix|floatformat:2 }}</span></div>
          <div class="flex px-3 justify-between"><span>C. Crédito</span><span>R$ {{ income_credit|floatformat:2 }}</span></div>
          <div class="flex px-3 py-1 justify-between"><span>C. Débito</span><span>R$ {{ income_debit|floatformat:2 }}</span></div>
          <div class="flex px-3 justify-between"><span>Dinheiro</span><span>R$ {{ income_cash|floatformat:2 }}</span></div>
          <hr class="my-2 border-white/40">
          <div class="flex px-3 py-2 justify-between font-semibold text-lg">
            <span>Total</span><span>R$ {{ total_incomes|floatformat:2 }}</span>
          </div>
        </div>
        <!-- Saídas -->
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <h3 class="bg-red-600 font-bold text-lg mb-2 p-1">(-) Saídas</h3>
          <div class="flex px-2 justify-between"><span>Pix</span><span>R$ {{expense_pix|floatformat:2}}</span></div>
          <div class="flex px-2 py-1 justify-between"><span>Boleto</span><span>R$ {{expense_boleto|floatformat:2}}</span></div>
          <div class="flex px-2 justify-between"><span>Débito Automático</span><span>R$ {{expense_automatic|floatformat:2}}</span></div>
          <div class="flex px-2 py-1 justify-between"><span>Retiradas</span><span>R$ {{expense_withdrawal|floatformat:2}}</span></div>
          <div class="flex px-2 justify-between"><span>Outros</span><span>R$ {{expense_others|floatformat:2}}</span></div>
          <hr class="my-2 border-white/40">
          <div class="flex px-2 justify-between font-semibold text-lg">
            <span>Total</span><span>R$ {{ total_expenses|floatformat:2 }}</span>
          </div>
        </div>
        <!-- Discriminação -->
        <div class="bg-white rounded-xl shadow  overflow-hidden">
          <h3 class="bg-gray-400 p-2 font-bold text-lg mb-3">Discriminação</h3>
          <div class="flex p-2 justify-between"><span>Saldo anterior</span><span>RS {{ opening_balance|floatformat:2 }}</span></div>
          <div class="flex px-2 justify-between"><span>(+) Entrada</span><span>R$  {{ total_incomes|floatformat:2 }}</span></div>
          <div class="flex p-2 justify-between"><span>(-) Saída</span><span>R$ {{ total_expenses|floatformat:2 }}</span></div>
          <hr class="my-2 border-gray-600/50">
          <div class="flex p-2 justify-between font-bold text-lg">
            <span>Saldo final</span><span>R$ {{closing_balance|floatformat:2}}</span>
          </div>
        </div>
      </div>
      <!-- Coluna da direita: Tabela -->
      <div class="col-span-3 bg-white rounded-2xl shadow-xl p-6 flex flex-col">
        <!-- Filtros -->
        <div class="flex items-center gap-4 mb-4">
          <button class="p-2 border rounded hover:bg-gray-100">
            <!-- Icone filtro -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2l-7 7v6l-4-2v-4L3 6V4z"/>
            </svg>
          </button>
          <button @click="entries = true, exits=false" class="px-3 py-1 border rounded-lg bg-gray-100 hover:cursor-pointer hover:bg-gray-400">Entrada</button>
          <button @click="entries = false, exits=true" class="px-3 py-1 border rounded-lg bg-gray-100 hover:cursor-pointer hover:bg-gray-400">Saída</button>
          <button @click="entries = true, exits=true" class="text-gray-500 hover:underline hover:cursor-pointer">Apagar filtros</button>
        </div>
        <!-- Tabela -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="border-b">
                <th class="text-left py-2 px-3 border-l">Data</th>
                <th class="text-left py-2 px-3 border-l">Tipo</th>
                <th class="text-left py-2 px-3 border-l">Valor</th>
                <th class="text-left py-2 px-3 border-l">Descrição</th>
                <th class="text-left py-2 px-3 border-l">Formato</th>
                <th class="text-left py-2 px-3 border-l">Subtotal</th>
              </tr>
            </thead>
            <tbody>

             {% for bill in bills %}
                <tr x-show="exits">
                <td> {{ bill.due_date|date:'d/m/y' }}</td>
                <td>Saída</td>
                <td>{{ bill.value }}</td>
                <td>{{ bill.description }}</td>
                <td>
                {% if bill.payment_method %}
                  {{ bill.payment_method }}
                  {% else %}
                  Em aberto
                {% endif %}
                  </td>
                <td>{{ bill.value }}</td>
              </tr>
              <!--Entradas-->
             {% endfor %}
             {% for payment  in payments %}
              <tr x-show="entries">
                <td> {{ payment.created_at|date:'d/m/y' }}</td>
                <td>Entrada</td>
                <td>{{ payment.value }}</td>
                <td>{{ payment.montlhyfee.student_name }}</td>
                <td>{{ payment.payment_method|title }}</td>
                <td>{{ payment.value }}</td>
              </tr>
             {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Rodapé -->
    <div class="w-full max-w-6xl flex justify-end gap-4 mt-6">
      <a href="{% url 'flow_cashier' %}"><button class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:cursor-pointer hover:bg-gray-500" >Acessar fluxo</button></a>

      {% if status == 'Aberto' %}
        <button @click="startclosecashier" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:cursor-pointer" >Fechar caixa</button>
      {% else %}
        <button @click='openCashier' class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:cursor-pointer" >Abrir Caixa</button>
      {% endif %}

      {% csrf_token %}
    </div>
    <!--MODAIS-->
    {% include 'components/_notification_modal.html' %}
    {% include 'components/_modal_close_cashier.html' %}
  </div>

  <script src="{% static 'js/notification_modal.js' %}"></script>
   <script src="{% static 'js/cashier.js' %}"></script>
{% endblock content %}
