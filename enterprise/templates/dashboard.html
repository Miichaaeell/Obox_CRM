{% extends "_base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-8 text-white">
  <div>
    <h1 class="text-2xl font-semibold">Dashboard</h1>
    <p class="text-sm text-gray-300">Visão centralizada dos indicadores acadêmicos, financeiros e fiscais.</p>
  </div>

  <!-- Resumo rápido -->
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-5 shadow-lg">
      <p class="text-sm text-gray-400">Alunos cadastrados</p>
      <p class="text-3xl font-bold">{{ students_summary.total }}</p>
      <p class="text-xs text-gray-400">{{ students_summary.active_percentage }}% ativos</p>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-5 shadow-lg">
      <p class="text-sm text-gray-400">Alunos ativos</p>
      <p class="text-3xl font-bold text-emerald-400">{{ students_summary.active }}</p>
      <p class="text-xs text-gray-400">Inativos: {{ students_summary.inactive }}</p>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-5 shadow-lg">
      <p class="text-sm text-gray-400">Mensalidades recebidas</p>
      <p class="text-3xl font-bold text-emerald-400">R$ {{ monthly_fee_values.paid_value|floatformat:2 }}</p>
      <p class="text-xs text-gray-400">Total emitido: R$ {{ monthly_fee_values.total_value|floatformat:2 }}</p>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-5 shadow-lg">
      <p class="text-sm text-gray-400">Mensalidades em aberto</p>
      <p class="text-3xl font-bold text-amber-400">R$ {{ monthly_fee_values.pending_value|floatformat:2 }}</p>
      <p class="text-xs text-gray-400">Pendentes: {{ monthly_fee_counts.pending_count }}</p>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-5 shadow-lg">
      <p class="text-sm text-gray-400">Contas em aberto</p>
      <p class="text-3xl font-bold text-fuchsia-400">{{ bills_summary.open_count }}</p>
      <p class="text-xs text-gray-400">Valor total: R$ {{ bills_summary.total_value|floatformat:2 }}</p>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-5 shadow-lg">
      <p class="text-sm text-gray-400">NFSe emitidas</p>
      <p class="text-3xl font-bold text-sky-400">{{ nfse_summary.total }}</p>
      <p class="text-xs text-gray-400">No mês: {{ nfse_summary.this_month }}</p>
    </div>
  </div>

  <!-- Fluxo mensal + status mensalidades -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <div class="xl:col-span-2 bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold">Fluxo de mensalidades</h2>
          <p class="text-xs text-gray-400">Comparativo dos últimos meses</p>
        </div>
      </div>
      <canvas id="cashflowChart" class="w-full h-64"></canvas>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg space-y-4">
      <div>
        <h2 class="text-lg font-semibold">Situação das mensalidades</h2>
        <p class="text-xs text-gray-400">Distribuição percentual</p>
      </div>
      <div class="space-y-3">
        <div>
          <div class="flex justify-between text-sm">
            <span>Pagas</span>
            <span>{{ monthly_fee_counts.paid_count }} ({{ monthly_fee_distribution.paid_pct }}%)</span>
          </div>
          <div class="w-full bg-gray-800 rounded-full h-2 mt-1">
            <div class="bg-emerald-500 h-2 rounded-full" style="width: {{ monthly_fee_distribution.paid_pct }}%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-sm">
            <span>Pendentes</span>
            <span>{{ monthly_fee_counts.pending_count }} ({{ monthly_fee_distribution.pending_pct }}%)</span>
          </div>
          <div class="w-full bg-gray-800 rounded-full h-2 mt-1">
            <div class="bg-amber-500 h-2 rounded-full" style="width: {{ monthly_fee_distribution.pending_pct }}%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-sm">
            <span>Vencidas</span>
            <span>{{ monthly_fee_counts.overdue_count }} ({{ monthly_fee_distribution.overdue_pct }}%)</span>
          </div>
          <div class="w-full bg-gray-800 rounded-full h-2 mt-1">
            <div class="bg-rose-500 h-2 rounded-full" style="width: {{ monthly_fee_distribution.overdue_pct }}%;"></div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <p class="text-gray-400 text-xs">A vencer (7 dias)</p>
          <p class="text-xl font-semibold">{{ monthly_fee_counts.due_next_count }}</p>
        </div>
        <div>
          <p class="text-gray-400 text-xs">Total de mensalidades</p>
          <p class="text-xl font-semibold">{{ monthly_fee_counts.total }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagamentos e contas -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold">Formas de pagamento</h2>
          <p class="text-xs text-gray-400">Valores recebidos por método</p>
        </div>
      </div>
      <canvas id="paymentChart" class="w-full h-60"></canvas>
      <ul class="mt-6 space-y-2 text-sm text-gray-300">
        {% for method in payment_method_stats %}
          <li class="flex justify-between">
            <span>{{ method.method }}</span>
            <span>R$ {{ method.total|floatformat:2 }} ({{ method.count }})</span>
          </li>
        {% empty %}
          <li class="text-gray-500">Nenhum pagamento registrado.</li>
        {% endfor %}
      </ul>
    </div>
    <div class="xl:col-span-2 bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold">Contas por status</h2>
          <p class="text-xs text-gray-400">Monitoramento das contas do estabelecimento</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-gray-300">
          <thead class="text-xs uppercase text-gray-400 border-b border-gray-700">
            <tr>
              <th class="py-2 text-left">Status</th>
              <th class="py-2 text-right">Quantidade</th>
              <th class="py-2 text-right">Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for bill in bills_by_status %}
              <tr class="border-b border-gray-800">
                <td class="py-3">{{ bill.status }}</td>
                <td class="py-3 text-right">{{ bill.total }}</td>
                <td class="py-3 text-right">R$ {{ bill.total_value|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="py-3 text-center text-gray-500">Nenhuma conta cadastrada.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Mensalidades próximas e atrasadas -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <h2 class="text-lg font-semibold mb-4">Vencem em breve</h2>
      <div class="space-y-3 text-sm">
        {% for fee in upcoming_fees %}
          <div class="flex justify-between border border-gray-800 rounded-xl px-4 py-2">
            <div>
              <p class="font-semibold">{{ fee.name }}</p>
              <p class="text-xs text-gray-400">Vencimento: {{ fee.due_date|date:"d/m/Y" }}</p>
            </div>
            <div class="text-right">
              <p class="text-amber-400 font-semibold">R$ {{ fee.amount|floatformat:2 }}</p>
              <p class="text-xs text-gray-400">{{ fee.plan }}</p>
            </div>
          </div>
        {% empty %}
          <p class="text-gray-500">Nenhuma mensalidade para os próximos dias.</p>
        {% endfor %}
      </div>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <h2 class="text-lg font-semibold mb-4">Em atraso</h2>
      <div class="space-y-3 text-sm">
        {% for fee in overdue_fees %}
          <div class="flex justify-between border border-gray-800 rounded-xl px-4 py-2">
            <div>
              <p class="font-semibold text-rose-300">{{ fee.name }}</p>
              <p class="text-xs text-gray-400">Venc. {{ fee.due_date|date:"d/m/Y" }}</p>
            </div>
            <div class="text-right">
              <p class="text-rose-400 font-semibold">R$ {{ fee.amount|floatformat:2 }}</p>
              <p class="text-xs text-gray-400">{{ fee.plan }}</p>
            </div>
          </div>
        {% empty %}
          <p class="text-gray-500">Não há mensalidades vencidas.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- NFSe + planos -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold">Últimas NFSe</h2>
          <p class="text-xs text-gray-400">Histórico recente de emissões</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-gray-300">
          <thead class="text-xs uppercase text-gray-400 border-b border-gray-700">
            <tr>
              <th class="py-2 text-left">Aluno</th>
              <th class="py-2 text-left">Referência</th>
              <th class="py-2 text-right">Data</th>
            </tr>
          </thead>
          <tbody>
            {% for invoice in recent_invoices %}
              <tr class="border-b border-gray-800">
                <td class="py-3">{{ invoice.student.name }}</td>
                <td class="py-3">{{ invoice.reference_month }}</td>
                <td class="py-3 text-right">{{ invoice.issue_date|date:"d/m/Y" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="py-3 text-center text-gray-500">Nenhuma NFSe emitida.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="bg-black/70 border border-gray-700 rounded-2xl p-6 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold">Planos mais contratados</h2>
          <p class="text-xs text-gray-400">Top planos por quantidade de alunos</p>
        </div>
      </div>
      <div class="space-y-3 text-sm">
        {% for plan in students_by_plan %}
          <div>
            <div class="flex justify-between">
              <p>{{ plan.name }}</p>
              <p>{{ plan.count }} alunos</p>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2 mt-1">
              <div class="bg-sky-500 h-2 rounded-full" style="width: {{ plan.percentage }}%;"></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">{{ plan.percentage }}% da base ativa</p>
          </div>
        {% empty %}
          <p class="text-gray-500">Nenhum aluno vinculado a planos.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const cashflowCtx = document.getElementById('cashflowChart');
  if (cashflowCtx) {
    const cashflowLabels = {{ monthly_cashflow_labels|safe }};
    const billedData = {{ monthly_cashflow_billed|safe }};
    const receivedData = {{ monthly_cashflow_received|safe }};
    new Chart(cashflowCtx, {
      type: 'line',
      data: {
        labels: cashflowLabels,
        datasets: [
          {
            label: 'Previsto (R$)',
            data: billedData,
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168,85,247,0.15)',
            tension: 0.4,
            fill: true
          },
          {
            label: 'Recebido (R$)',
            data: receivedData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,0.2)',
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#e5e7eb' } } },
        scales: {
          x: { ticks: { color: '#9ca3af' }, grid: { color: '#1f2937' } },
          y: { ticks: { color: '#9ca3af' }, grid: { color: '#1f2937' } }
        }
      }
    });
  }

  const paymentCtx = document.getElementById('paymentChart');
  if (paymentCtx) {
    const paymentLabels = {{ payment_method_labels|safe }};
    const paymentValues = {{ payment_method_totals|safe }};
    new Chart(paymentCtx, {
      type: 'doughnut',
      data: {
        labels: paymentLabels,
        datasets: [{
          data: paymentValues,
          backgroundColor: ['#14b8a6', '#8b5cf6', '#f97316', '#f43f5e', '#38bdf8', '#facc15']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#e5e7eb' }
          }
        }
      }
    });
  }
</script>
{% endblock %}
